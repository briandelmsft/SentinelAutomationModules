{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "enableModulesKind": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": "The automation modules you want to deploy"
            }
        },
        "OOFPlaybookName": {
            "defaultValue": "Get-OOFDetails",
            "type": "String"
        },
        "RelatedAlertsPlaybookName": {
            "defaultValue": "Get-RelatedAlerts",
            "type": "String"
        },
        "UEBAPlaybookName": {
            "defaultValue": "Get-UEBAInsights",
            "type": "String"
        },
        "WatchlistPlaybookName": {
            "defaultValue": "Get-WatchlistInsights",
            "type": "String"
        },
        "MDEPlaybookName": {
            "defaultValue": "Get-MDEUsersDevicesRiskScore",
            "type": "String"
        },
        "AADRisksPlaybookName": {
            "defaultValue": "Get-AADUserRisksInfo",
            "type": "String"
        },
        "TIPlaybookName": {
            "defaultValue": "Get-ThreatIntel",
            "type": "String"
        },
        "MCASPlaybookName": {
            "defaultValue": "Get-MCASInvestigationScore",
            "type": "String"
        },
        "SamplePlaybookName": {
            "defaultValue": "Triage-Incident",
            "type": "String"
        },
        "DeploySamplePlaybook": {
            "defaultValue": false,
            "type": "bool"
        },
        "DeployConnector": {
            "defaultValue": true,
            "type": "bool"
        },
        "StandardSetup": {
            "defaultValue": false,
            "type": "bool"
        },
        "FilePlaybookName": {
            "defaultValue": "Get-FileInsights",
            "type": "String"
        },
        "KQLPlaybookName": {
            "defaultValue": "Run-KQLQuery",
            "type": "String"
        },
        "BasePlaybookName": {
            "defaultValue": "Base-Module",
            "type": "String"
        },
        "STATCoordinatorPlaybookName": {
            "defaultValue": "STAT-Coordinator",
            "type": "String"
        },
        "CustomConnectorName": {
            "defaultValue": "SentinelTriageAssistant",
            "type": "String"
        },
        "CustomConnectorDisplayName": {
            "defaultValue": "Sentinel Triage AssistanT - STAT",
            "type": "String"
        }
    },
    "variables": {
        "OOFTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/OOFModule/azuredeploy.json",
        "RelatedAlertsTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/RelatedAlerts/azuredeploy.json",
        "UEBATemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/UEBAModule/azuredeploy.json",
        "MCASTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/MCASModule/azuredeploy.json",
        "MDETemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/MDEModule/azuredeploy.json",
        "AADTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/AADRisksModule/azuredeploy.json",
        "WatchlistTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/WatchlistModule/azuredeploy.json",
        "FileTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/FileModule/azuredeploy.json",
        "KQLTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/KQLModule/azuredeploy.json",
        "TITemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/TIModule/azuredeploy.json",
        "BaseTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/BaseModule/azuredeploy.json",
        "SampleTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Samples/azuredeploy.json",
        "ConnectorTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/statconnector/Connector/azuredeploy.json"
    },
    "resources": [
        {
            "apiVersion": "2019-10-01",
            "name": "BaseTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('BaseTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('BasePlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'KQLModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "KQLTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('KQLTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('KQLPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'TIModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "TITemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('TITemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('TIPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'FileModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "FileTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('FileTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('FilePlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'OOFModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "OOFTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('OOFTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('OOFPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'WatchlistModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "WatchlistTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('WatchlistTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('WatchlistPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'AADModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "AADTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('AADTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('AADRisksPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'MCASModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "MCASTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('MCASTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('MCASPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'UEBAModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "UEBATemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('UEBATemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('UEBAPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'MDEModule'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "MDETemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('MDETemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('MDEPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[or(contains(parameters('enableModulesKind'), 'RelatedAlerts'),parameters('StandardSetup'))]",
            "apiVersion": "2019-10-01",
            "name": "RelatedAlertsTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('RelatedAlertsTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('RelatedAlertsPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[parameters('DeploySamplePlaybook')]",
            "apiVersion": "2019-10-01",
            "name": "SamplePlaybook",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'OOFTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'RelatedAlertsTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'UEBATemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'BaseTemplate')]"
            ],
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('SampleTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "PlaybookName": {
                        "value": "[parameters('SamplePlaybookName')]"
                    },
                    "OOFPlaybook_ResourceId": {
                        "value": "[reference('OOFTemplate').outputs.resourceID.value]"
                    },
                    "RelatedAlertsPlaybook_ResourceId": {
                        "value": "[reference('RelatedAlertsTemplate').outputs.resourceID.value]"
                    },
                    "UEBAInsightsPlaybook_ResourceId": {
                        "value": "[reference('UEBATemplate').outputs.resourceID.value]"
                    }
                }
            }
        },
        {
            "condition": "[parameters('DeployConnector')]",
            "apiVersion": "2019-10-01",
            "name": "DeployConnector",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'OOFTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'RelatedAlertsTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'UEBATemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'BaseTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'MCASTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'MDETemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'AADTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'WatchlistTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'FileTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'KQLTemplate')]",
                "[resourceId('Microsoft.Resources/deployments', 'TITemplate')]"
            ],
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('ConnectorTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "STATCoordinatorPlaybookName": {
                        "value": "[parameters('STATCoordinatorPlaybookName')]"
                    },
                    "CustomConnectorName": {
                        "value": "[parameters('CustomConnectorName')]"
                    },
                    "CustomConnectorDisplayName": {
                        "value": "[parameters('CustomConnectorDisplayName')]"
                    },
                    "OOFModule_resourceid": {
                        "value": "[reference('OOFTemplate').outputs.resourceID.value]"
                    },
                    "RelatedAlertsModule_resourceid": {
                        "value": "[reference('RelatedAlertsTemplate').outputs.resourceID.value]"
                    },
                    "UEBAModule_resourceid": {
                        "value": "[reference('UEBATemplate').outputs.resourceID.value]"
                    },
                    "BaseModule_resourceid": {
                        "value": "[reference('BaseTemplate').outputs.resourceID.value]"
                    },
                    "AADRisks_resourceid": {
                        "value": "[reference('AADTemplate').outputs.resourceID.value]"
                    },
                    "FileModule_resourceid": {
                        "value": "[reference('FileTemplate').outputs.resourceID.value]"
                    },
                    "KQLModule_resourceid": {
                        "value": "[reference('KQLTemplate').outputs.resourceID.value]"
                    },
                    "MCASModule_resourceid": {
                        "value": "[reference('MCASTemplate').outputs.resourceID.value]"
                    },
                    "MDEModule_resourceid": {
                        "value": "[reference('MDETemplate').outputs.resourceID.value]"
                    },
                    "ThreatIntelModule_resourceid": {
                        "value": "[reference('TITemplate').outputs.resourceID.value]"
                    },
                    "WatchlistModule_resourceid": {
                        "value": "[reference('WatchlistTemplate').outputs.resourceID.value]"
                    }
                }
            }
        }
    ]
}