{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "enableModulesKind": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": "The automation modules you want to deploy"
            }
        },
	"OOFPlaybookName": {
		"defaultValue": "Get-OOFDetails",
		"type": "String"
	},
	"RelatedAlertsPlaybookName": {
		"defaultValue": "Get-RelatedAlerts",
		"type": "String"
	},
	"UEBAPlaybookName": {
		"defaultValue": "Get-UEBAInsights",
		"type": "String"
	},
	"MDEPlaybookName": {
		"defaultValue": "Get-MDEUsersDevicesRiskScore",
		"type": "String"
	},
        "MCASPlaybookName": {
            "defaultValue": "Get-MCASInvestigationScore",
            "type": "String"
        },
        "MCAS API KEY": {
            "defaultValue": "Type your API Key",
            "type": "String"
        },
        "MCAS API URL": {
            "defaultValue": "Type your API URL",
            "type": "String"
        },
        "SamplePlaybookName": {
            "defaultValue": "Triage-Incident",
            "type": "String"
        },
        "DeploySamplePlaybook": {
            "defaultValue": false,
            "type": "bool"
        }
	},
    "variables": {  
	"OOFTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/OOFModule/azuredeploy.json",
        "RelatedAlertsTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/RelatedAlerts/azuredeploy.json",
        "UEBATemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/UEBAModule/azuredeploy.json",
	"MCASTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/MCASModule/azuredeploy.json",
	"MDETemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Modules/MDEModule/azuredeploy.json",
	"SampleTemplate": "https://raw.githubusercontent.com/briandelmsft/SentinelAutomationModules/main/Samples/azuredeploy.json"
    },
    "resources": [
        {
            "condition": "[contains(parameters('enableModulesKind'), 'OOFModule')]",
            "apiVersion": "2019-10-01",
            "name": "OOFTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('OOFTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
					"PlaybookName": { 
                        "value": "[parameters('OOFPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[contains(parameters('enableModulesKind'), 'MCASModule')]",
            "apiVersion": "2019-10-01",
            "name": "MCASTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('MCASTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
		            "PlaybookName": { 
                        "value": "[parameters('MCASPlaybookName')]"
                    },
		            "API KEY": { 
                        "value": "[parameters('MCAS API KEY')]"
                    },
		            "MCAS API URL": { 
                        "value": "[parameters('MCAS API URL')]"
                    }
                }
            }
        },
        {
            "condition": "[contains(parameters('enableModulesKind'), 'UEBAModule')]",
            "apiVersion": "2019-10-01",
            "name": "UEBATemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('UEBATemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
					"PlaybookName": { 
                        "value": "[parameters('UEBAPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[contains(parameters('enableModulesKind'), 'MDEModule')]",
            "apiVersion": "2019-10-01",
            "name": "MDETemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('MDETemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
					"PlaybookName": { 
                        "value": "[parameters('MDEPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[contains(parameters('enableModulesKind'), 'RelatedAlerts')]",
            "apiVersion": "2019-10-01",
            "name": "RelatedAlertsTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('RelatedAlertsTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
					"PlaybookName": {
                        "value": "[parameters('RelatedAlertsPlaybookName')]"
                    }
                }
            }
        },
        {
            "condition": "[parameters('DeploySamplePlaybook')]",
            "apiVersion": "2019-10-01",
            "name": "SamplePlaybook",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'OOFTemplate')]",
		"[resourceId('Microsoft.Resources/deployments', 'RelatedAlertsTemplate')]",
		"[resourceId('Microsoft.Resources/deployments', 'UEBATemplate')]"
            ],
            "properties": {
                "mode": "incremental",
                "templateLink": {
                    "uri": "[variables('SampleTemplate')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
		    "PlaybookName": { 
                        "value": "[parameters('SamplePlaybookName')]"
                    },
		    "OOFPlaybook_ResourceId": { 
                        "value": "[reference('OOFTemplate').outputs.resourceID.value]"
                    },
		    "RelatedAlertsPlaybook_ResourceId": { 
                        "value": "[reference('RelatedAlertsTemplate').outputs.resourceID.value]"
                    },
		    "UEBAInsightsPlaybook_ResourceId": { 
                        "value": "[reference('UEBATemplate').outputs.resourceID.value]"
                    }
                }
            }
        }
    ]
}
